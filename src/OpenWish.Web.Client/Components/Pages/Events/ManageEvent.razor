@page "/events/{EventId}/manage"
@attribute [Authorize]

@using OpenWish.Web.Client.Components.Event
@using OpenWish.Shared.Services
@using System.Collections.Generic
@using System.Linq

@inject IEventService EventService
@inject IUserContextService UserContextService
@inject NavigationManager NavigationManager

@rendermode InteractiveAuto

<PageTitle>Manage Event - @(_event?.Name ?? "")</PageTitle>

@if (_event == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!_isOwner)
{
    <div class="alert alert-danger" role="alert">
        You do not have permission to manage this event.
    </div>
}
else
{
    <div class="event-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Manage Event</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" type="button" @onclick="HandleCancel">
                        <i class="bi bi-arrow-left"></i> Back to Event
                    </button>
                    <button class="btn btn-danger" type="button" @onclick="ShowDeleteConfirmation">
                        <i class="bi bi-trash"></i> Delete Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        @* <FormMappingScope Name="edit-event"> *@
                            <EventForm Model="@_event"
                                     OnSubmit="@HandleSubmit"
                                     ShowValidationSummary="true" />
                        @* </FormMappingScope> *@
                    </div>
                </div>

                <div class="mt-4">
                    <EventWishlistManager EventId="@EventId"
                                           Event="@_event"
                                           CurrentUserId="@_currentUserId"
                                           OnWishlistsChanged="HandleWishlistsChanged" />
                </div>
            </div>
            <div class="col-md-4">
                <EventInvitations EventId="@EventId" IsOwner="true" CurrentUserId="@_currentUserId" />

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h3>Manage Participants</h3>
                        @{
                            var participants = GetParticipantList().ToList();
                            var hasOwner = _event?.CreatedBy != null;
                        }
                        <div class="list-group mt-3">
                            @if (hasOwner)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>@GetOwnerDisplayName()</strong>
                                        @if (GetOwnerContactDetail() is { } ownerContact)
                                        {
                                            <div class="small text-muted">@ownerContact</div>
                                        }
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            <span class="badge bg-secondary">Owner</span>
                                        </div>
                                    </div>
                                </div>
                            }

                            @foreach (var participant in participants)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="me-3">
                                        <strong>@GetParticipantDisplayName(participant)</strong>
                                        @if (GetParticipantContactDetail(participant) is { } contact)
                                        {
                                            <div class="small text-muted">@contact</div>
                                        }
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            <span class="badge bg-primary">@participant.Role</span>
                                            <span class="badge @GetStatusBadgeClass(participant)">@GetNormalizedStatus(participant)</span>
                                        </div>
                                    </div>
                                    @if (participant.User?.Id is string participantUserId && participantUserId != _currentUserId)
                                    {
                                        <button class="btn btn-outline-danger btn-sm"
                                                @onclick="() => HandleRemoveParticipant(participant)">
                                            Remove
                                        </button>
                                    }
                                </div>
                            }

                            @if (!hasOwner && participants.Count == 0)
                            {
                                <div class="list-group-item text-muted">No participants yet.</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (_showDeleteConfirmation && _event is not null)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Event</h5>
                    <button type="button" class="btn-close" @onclick="CancelDeleteEvent" disabled="@_isDeleting"></button>
                </div>
                <div class="modal-body">
                    @if (_deleteConfirmationStep == DeleteConfirmationStep.First)
                    {
                        <p>Deleting <strong>@_event.Name</strong> will remove all wishlists, participants, and activity. This action cannot be undone.</p>
                        <p class="mb-0">Click "Continue" to confirm once more before permanently deleting the event.</p>
                    }
                    else
                    {
                        <p>This is your final confirmation. Once you delete <strong>@_event.Name</strong>, it cannot be restored.</p>
                        <p class="text-danger mb-0">Are you absolutely sure you want to permanently delete this event?</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDeleteEvent" disabled="@_isDeleting">Cancel</button>
                    @if (_deleteConfirmationStep == DeleteConfirmationStep.First)
                    {
                        <button type="button" class="btn btn-warning" @onclick="ConfirmFirstDeleteStep">Continue</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteEventAsync" disabled="@_isDeleting">
                            @if (_isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Deleting...</span>
                            }
                            else
                            {
                                <span>Delete Event</span>
                            }
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

@code {
    [Parameter] public string EventId { get; set; } = string.Empty;
    private EventModel? _event;
    private string? _currentUserId;
    private bool _isOwner;
    private bool _showDeleteConfirmation;
    private bool _isDeleting;
    private DeleteConfirmationStep _deleteConfirmationStep = DeleteConfirmationStep.First;

    protected override async Task OnInitializedAsync()
    {
        _currentUserId = await UserContextService.GetUserIdAsync();
        await LoadEvent();
    }

    private async Task LoadEvent()
    {
        _event = await EventService.GetEventByPublicIdAsync(EventId);
        _isOwner = _event?.CreatedBy.Id == _currentUserId;

        if (!_isOwner)
        {
            NavigationManager.NavigateTo($"/events/{EventId}");
        }
    }

    private async Task HandleSubmit(EventModel updatedEvent)
    {
        if (_event != null)
        {
            await EventService.UpdateEventByPublicIdAsync(EventId, updatedEvent);
            NavigationManager.NavigateTo($"/events/{EventId}");
        }
    }

    private void HandleCancel()
    {
        NavigationManager.NavigateTo($"/events/{EventId}");
    }

    private void ShowDeleteConfirmation()
    {
        if (_event == null)
        {
            return;
        }

        _deleteConfirmationStep = DeleteConfirmationStep.First;
        _showDeleteConfirmation = true;
    }

    private void CancelDeleteEvent()
    {
        if (_isDeleting)
        {
            return;
        }

        _showDeleteConfirmation = false;
        _deleteConfirmationStep = DeleteConfirmationStep.First;
    }

    private void ConfirmFirstDeleteStep()
    {
        if (_event == null)
        {
            return;
        }

        _deleteConfirmationStep = DeleteConfirmationStep.Second;
    }

    private async Task ConfirmDeleteEventAsync()
    {
        if (_event == null || _isDeleting)
        {
            return;
        }

        _isDeleting = true;

        try
        {
            await EventService.DeleteEventByPublicIdAsync(EventId);
            _showDeleteConfirmation = false;
            NavigationManager.NavigateTo("/events");
        }
        finally
        {
            _isDeleting = false;
        }
    }

    private async Task HandleRemoveParticipant(EventUserModel participant)
    {
        if (participant.User?.Id is null || string.IsNullOrEmpty(_currentUserId))
        {
            return;
        }

        await EventService.RemoveUserFromEventByPublicIdAsync(EventId, participant.User.Id, _currentUserId);
        await LoadEvent();
    }

    private IEnumerable<EventUserModel> GetParticipantList() =>
        _event?.EventUsers?
            .Where(eu => !IsOwner(eu))
            .OrderBy(eu => GetStatusSortOrder(eu))
            .ThenBy(eu => GetParticipantDisplayName(eu), StringComparer.OrdinalIgnoreCase)
        ?? Enumerable.Empty<EventUserModel>();

    private bool IsOwner(EventUserModel eventUser) =>
        !string.IsNullOrWhiteSpace(_event?.CreatedBy?.Id) &&
        string.Equals(eventUser.User?.Id, _event!.CreatedBy!.Id, StringComparison.Ordinal);

    private static int GetStatusSortOrder(EventUserModel eventUser) => GetNormalizedStatus(eventUser) switch
    {
        "Accepted" => 0,
        "Pending" => 1,
        "Rejected" => 2,
        _ => 3
    };

    private static string GetStatusBadgeClass(EventUserModel eventUser) => GetNormalizedStatus(eventUser) switch
    {
        "Accepted" => "bg-success",
        "Pending" => "bg-warning text-dark",
        "Rejected" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetParticipantDisplayName(EventUserModel eventUser)
    {
        if (!string.IsNullOrWhiteSpace(eventUser.User?.UserName))
        {
            return eventUser.User.UserName!;
        }

        if (!string.IsNullOrWhiteSpace(eventUser.InviteeEmail))
        {
            return eventUser.InviteeEmail!;
        }

        return "Pending Invitation";
    }

    private static string? GetParticipantContactDetail(EventUserModel eventUser)
    {
        if (!string.IsNullOrWhiteSpace(eventUser.User?.Email))
        {
            return eventUser.User.Email!;
        }

        return eventUser.InviteeEmail;
    }

    private string GetOwnerDisplayName()
    {
        if (!string.IsNullOrWhiteSpace(_event?.CreatedBy?.UserName))
        {
            return _event!.CreatedBy!.UserName!;
        }

        if (!string.IsNullOrWhiteSpace(_event?.CreatedBy?.Email))
        {
            return _event!.CreatedBy!.Email!;
        }

        return "Event Owner";
    }

    private string? GetOwnerContactDetail() =>
        string.IsNullOrWhiteSpace(_event?.CreatedBy?.Email) ? null : _event!.CreatedBy!.Email!;

    private static string GetNormalizedStatus(EventUserModel eventUser)
    {
        if (!string.IsNullOrWhiteSpace(eventUser.Status))
        {
            return eventUser.Status;
        }

        return eventUser.IsAccepted ? "Accepted" : "Pending";
    }

    private Task HandleWishlistsChanged(IReadOnlyList<WishlistModel> wishlists)
    {
        if (_event != null)
        {
            _event.EventWishlists = wishlists.ToList();
        }

        return Task.CompletedTask;
    }

    private enum DeleteConfirmationStep
    {
        First,
        Second
    }
}
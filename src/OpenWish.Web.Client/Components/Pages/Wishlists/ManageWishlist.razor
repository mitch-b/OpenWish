@attribute [Authorize]
@page "/wishlists/{WishlistId:int}/manage"
@using OpenWish.Web.Client.Components.Wishlist
@using OpenWish.Shared.Models
@using System.Collections.Generic
@using System.Linq
@using System.Net.Http

@inject IWishlistService WishlistService
@inject NavigationManager NavigationManager
@inject IUserContextService UserContextService
@inject ILogger<ManageWishlist> Logger
@inject IEventService EventService

@rendermode InteractiveAuto

<PageTitle>Manage Wishlist - @(_wishlist?.Name ?? "")</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Manage Wishlist</h3>
    <div class="btn-group">
        <a href="/wishlists/@WishlistId" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Wishlist
        </a>
        <button class="btn btn-danger" type="button" @onclick="ShowDeleteDialog">
            <i class="bi bi-trash"></i> Delete Wishlist
        </button>
    </div>
</div>

@if (_wishlist == null)
{
    <p>Loading...</p>
}
else if (!_isOwner)
{
    <div class="alert alert-danger">
        You don't have permission to manage this wishlist.
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <WishlistForm Model="_wishlist" OnSubmit="HandleSubmit" />
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h4 class="h5">Event Association</h4>

            @if (!string.IsNullOrEmpty(_eventStatusMessage))
            {
                <div class="alert alert-success" role="alert">@_eventStatusMessage</div>
            }

            @if (!string.IsNullOrEmpty(_eventErrorMessage))
            {
                <div class="alert alert-danger" role="alert">@_eventErrorMessage</div>
            }

            @if (_attachedEvent is not null)
            {
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-semibold">@_attachedEvent.Name</div>
                        <div class="small text-muted">@_attachedEvent.Date.ToString("MMMM d, yyyy")</div>
                        @if (_attachedEvent.Budget.HasValue)
                        {
                            <div class="small text-muted">Budget: @_attachedEvent.Budget.Value.ToString("C")</div>
                        }
                    </div>
                    <div class="btn-group">
                        <a href="/events/@_attachedEvent.Id" class="btn btn-outline-primary btn-sm">View Event</a>
                        <button class="btn btn-outline-secondary btn-sm"
                                type="button"
                                disabled="@_eventBusy"
                                @onclick="DetachFromEventAsync">
                            Remove
                        </button>
                    </div>
                </div>
            }
            else if (_availableEvents.Any())
            {
                <div class="mb-3">
                    <label class="form-label">Attach to an event</label>
                    <div class="input-group">
                        <select class="form-select"
                                @bind="_selectedEventId"
                                disabled="@_eventBusy">
                            <option value="">Select an event</option>
                            @foreach (var evt in _availableEvents)
                            {
                                <option value="@evt.Id">@GetEventOptionLabel(evt)</option>
                            }
                        </select>
                        <button class="btn btn-primary"
                                type="button"
                                disabled="@(!_selectedEventId.HasValue || _eventBusy)"
                                @onclick="AttachToSelectedEventAsync">
                            Attach
                        </button>
                    </div>
                </div>
            }
            else
            {
                <p class="text-muted small mb-0">You do not have any upcoming events to attach this wishlist to yet.</p>
            }
        </div>
    </div>
}

<WishlistDeleteDialog @ref="deleteDialog" OnConfirm="HandleDeleteWishlist" />

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

@code {
    [Parameter]
    public int WishlistId { get; set; }

    private WishlistModel? _wishlist;
    private WishlistDeleteDialog deleteDialog;
    private string? _currentUserId;
    private bool _isOwner;
    private List<EventModel> _availableEvents = [];
    private EventModel? _attachedEvent;
    private int? _selectedEventId;
    private bool _eventBusy;
    private string? _eventStatusMessage;
    private string? _eventErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentUserId = await UserContextService.GetUserIdAsync();
            _wishlist = await WishlistService.GetWishlistAsync(WishlistId, _currentUserId);
            await SetupSecurity();

            if (_isOwner)
            {
                await RefreshEventsAsync();
            }
        }
        catch (UnauthorizedAccessException)
        {
            // Redirect to access denied or navigate away
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
        catch (KeyNotFoundException)
        {
            // Wishlist not found, redirect to wishlists
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
    }

    private Task SetupSecurity()
    {
        if (_wishlist == null || string.IsNullOrEmpty(_currentUserId)) 
            return Task.CompletedTask;

        _isOwner = _wishlist.OwnerId == _currentUserId;
        return Task.CompletedTask;
    }

    private async Task HandleSubmit(WishlistModel updatedWishlist)
    {
        await WishlistService.UpdateWishlistAsync(WishlistId, updatedWishlist);
        NavigationManager.NavigateTo($"/wishlists/{WishlistId}");
    }

    private void ShowDeleteDialog()
    {
        deleteDialog.Show(
            "Delete Wishlist",
            $"Are you sure you want to delete the wishlist '{_wishlist?.Name}'? This action cannot be undone."
        );
    }

    private async Task HandleDeleteWishlist()
    {
        try
        {
            await WishlistService.DeleteWishlistAsync(WishlistId);
            NavigationManager.NavigateTo("/wishlists");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting wishlist {WishlistId}", WishlistId);
        }
    }

    private async Task RefreshEventsAsync()
    {
        if (string.IsNullOrEmpty(_currentUserId))
        {
            _availableEvents.Clear();
            _attachedEvent = null;
            return;
        }

        try
        {
            var events = (await EventService.GetUserEventsAsync(_currentUserId)).ToList();
            _availableEvents = events
                .Where(e => _wishlist?.EventId == null || e.Id != _wishlist.EventId)
                .OrderBy(e => e.Date)
                .ToList();

            if (_wishlist?.EventId is int eventId)
            {
                _attachedEvent = await EventService.GetEventAsync(eventId);
            }
            else
            {
                _attachedEvent = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load events for wishlist {WishlistId}", WishlistId);
            _availableEvents.Clear();

            if (_wishlist?.EventId is int eventId)
            {
                try
                {
                    _attachedEvent = await EventService.GetEventAsync(eventId);
                }
                catch (Exception innerEx)
                {
                    Logger.LogWarning(innerEx, "Failed to fetch event {EventId} for wishlist {WishlistId}", eventId, WishlistId);
                    _attachedEvent = null;
                }
            }
        }
    }

    private async Task AttachToSelectedEventAsync()
    {
        if (!_selectedEventId.HasValue || _wishlist == null || string.IsNullOrEmpty(_currentUserId))
        {
            return;
        }

        var eventId = _selectedEventId.Value;

        await ExecuteEventAction(async () =>
        {
            await EventService.AttachWishlistAsync(eventId, WishlistId, _currentUserId);
            _wishlist.EventId = eventId;
            _attachedEvent = await EventService.GetEventAsync(eventId);
            _eventStatusMessage = $"Attached to '{_attachedEvent.Name}'.";
            _selectedEventId = null;
        });
    }

    private async Task DetachFromEventAsync()
    {
        if (_attachedEvent == null || _wishlist == null || string.IsNullOrEmpty(_currentUserId))
        {
            return;
        }

        var eventId = _attachedEvent.Id;
        var eventName = _attachedEvent.Name;

        await ExecuteEventAction(async () =>
        {
            var removed = await EventService.DetachWishlistAsync(eventId, WishlistId, _currentUserId);
            if (removed)
            {
                _wishlist.EventId = null;
                _attachedEvent = null;
                _eventStatusMessage = $"Removed this wishlist from '{eventName}'.";
            }
        });
    }

    private async Task ExecuteEventAction(Func<Task> action)
    {
        try
        {
            _eventBusy = true;
            _eventErrorMessage = null;
            _eventStatusMessage = null;

            await action();
            await RefreshEventsAsync();
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Network error updating events for wishlist {WishlistId}", WishlistId);
            _eventErrorMessage = "We couldn't reach the server. Please try again.";
        }
        catch (UnauthorizedAccessException ex)
        {
            Logger.LogWarning(ex, "Unauthorized attempt to modify event assignment for wishlist {WishlistId}", WishlistId);
            _eventErrorMessage = "You do not have permission to update event associations.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error updating event association for wishlist {WishlistId}", WishlistId);
            _eventErrorMessage = ex.Message;
        }
        finally
        {
            _eventBusy = false;
            StateHasChanged();
        }
    }

    private static string GetEventOptionLabel(EventModel evt)
    {
        return $"{evt.Name} ({evt.Date:MMM d, yyyy})";
    }
}

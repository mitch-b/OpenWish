@attribute [Authorize]
@page "/wishlists/{WishlistId:int}"

@using OpenWish.Shared.Services
@using OpenWish.Web.Client.Components.Wishlist

@inject IUserContextService UserContextService
@inject IWishlistService WishlistService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@rendermode InteractiveAuto

<PageTitle>@(_wishlist?.Name ?? "Wishlist")</PageTitle>

@if (_wishlist == null)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading wishlist...</p>
    </div>
}
else
{
    <div class="wishlist-header mb-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2>
                    @if (!string.IsNullOrEmpty(_wishlist.Icon))
                    {
                        <span style="font-size: 1.2em; margin-right: 0.3em;">@_wishlist.Icon</span>
                    }
                    @_wishlist.Name
                </h2>
                @if (_wishlist.IsCollaborative)
                {
                    <span class="badge bg-info">Collaborative Wishlist</span>
                }
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary d-inline-flex align-items-center" @onclick="ShareWishlist">
                    <i class="bi bi-share me-2"></i> Share
                </button>
                @if (_isOwner)
                {
                    <a href="/wishlists/@WishlistId/manage" class="btn btn-light d-inline-flex align-items-center">
                        <i class="bi bi-gear me-2"></i> Manage Wishlist
                    </a>
                }
            </div>
        </div>
    </div>

    <div class="controls-bar mb-3">
        <div class="controls-left">
            <div class="btn-group sort-group">
                <button class="btn @(SortBy == "name" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SortItems("name"))">
                    <i class="bi bi-sort-alpha-down"></i> Name
                </button>
                <button class="btn @(SortBy == "priority" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SortItems("priority"))">
                    <i class="bi bi-sort-numeric-down"></i> Priority
                </button>
                <button class="btn @(SortBy == "price" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SortItems("price"))">
                    <i class="bi bi-currency-dollar"></i> Price
                </button>
            </div>
        </div>

        <div class="controls-right">
            <select class="form-select priority-filter" @bind="PriorityFilter">
                <option value="all">All Priorities</option>
                <option value="1">High Priority</option>
                <option value="2">Medium Priority</option>
                <option value="3">Low Priority</option>
            </select>
            
            <div class="btn-group view-toggle" role="group" aria-label="View toggle">
                <button type="button" class="btn @(ViewMode == "list" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetViewMode("list"))">
                    <i class="bi bi-list-ul"></i>
                </button>
                <button type="button" class="btn @(ViewMode == "card" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => SetViewMode("card"))">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="wishlist-content">
        @if (_items != null)
        {
            @if (_filteredItems.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <h4>No items yet</h4>
                    <p>@(_canEdit ? "Start adding items to your wishlist!" : "This wishlist doesn't have any items matching your filters.")</p>
                    @if (_canEdit)
                    {
                        <button class="btn btn-primary" @onclick="ShowAddItemModal">
                            <i class="bi bi-plus-lg"></i> Add Your First Item
                        </button>
                    }
                </div>
            }
            else
            {
                @if (ViewMode == "list")
                {
                    @if (_canEdit)
                    {
                        <WishlistItemList Items="@_filteredItems" 
                                        OnEdit="@HandleItemEditClick" 
                                        OnDelete="@HandleItemDelete" 
                                        ShowInteractions="true" 
                                        WishlistId="@WishlistId" 
                                        OwnerId="@(_wishlist?.OwnerId ?? "")" 
                                        IsOwner="@_isOwner" />
                    }
                    else
                    {
                        <WishlistItemList Items="@_filteredItems" 
                                        ShowInteractions="true" 
                                        WishlistId="@WishlistId" 
                                        OwnerId="@(_wishlist?.OwnerId ?? "")" 
                                        IsOwner="@_isOwner" />
                    }
                }
                else
                {
                    @if (_canEdit)
                    {
                        <WishlistCardView Items="@_filteredItems" 
                                        OnEdit="@HandleItemEditClick" 
                                        OnDelete="@HandleItemDelete" 
                                        ShowInteractions="true" 
                                        WishlistId="@WishlistId" 
                                        OwnerId="@(_wishlist?.OwnerId ?? "")" 
                                        IsOwner="@_isOwner" />
                    }
                    else
                    {
                        <WishlistCardView Items="@_filteredItems" 
                                        ShowInteractions="true" 
                                        WishlistId="@WishlistId" 
                                        OwnerId="@(_wishlist?.OwnerId ?? "")" 
                                        IsOwner="@_isOwner" />
                    }
                }
            }
        }
        else
        {
            <div class="loading-container">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading items...</p>
            </div>
        }
    </div>

    @if (_canEdit)
    {
        <button class="fab" @onclick="ShowAddItemModal" title="Add New Item">
            <i class="bi bi-plus-lg"></i>
        </button>
    }
}

<WishlistItemModal @ref="_itemModal" Model="@_modalItem" OnSubmit="@HandleModalSubmit" OnCancel="@HandleModalCancel" />

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

@code {

    [Parameter]
    public int WishlistId { get; set; }

    private WishlistModel? _wishlist;
    private List<WishlistItemModel> _items = new();
    private List<WishlistItemModel> _filteredItems = new();
    private WishlistItemModel _modalItem = new();
    private WishlistItemModal? _itemModal;
    private string? _currentUserId;
    private bool _canEdit;
    private bool _isOwner;
    private string SortBy { get; set; } = "priority";
    private bool SortAscending { get; set; } = true;
    private string PriorityFilter { get; set; } = "all";
    private string ViewMode { get; set; } = "card"; // "list" or "card"

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentUserId = await UserContextService.GetUserIdAsync();
            _wishlist = await WishlistService.GetWishlistAsync(WishlistId, _currentUserId);
            await SetupSecurity();
            await LoadItems();
        }
        catch (UnauthorizedAccessException)
        {
            // Redirect to access denied or navigate away
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
        catch (KeyNotFoundException)
        {
            // Wishlist not found, redirect to wishlists
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
    }

    private async Task LoadItems()
    {
        _items = (await WishlistService.GetWishlistItemsAsync(WishlistId)).ToList();
        ApplyFiltersAndSort();
    }

    private void ApplyFiltersAndSort()
    {
        var filtered = _items.AsEnumerable();

        // Apply priority filter
        if (PriorityFilter != "all")
        {
            if (int.TryParse(PriorityFilter, out int priority))
            {
                filtered = filtered.Where(i => i.Priority == priority);
            }
        }

        // Apply sorting
        filtered = SortBy switch
        {
            "name" => SortAscending 
                ? filtered.OrderBy(i => i.Name) 
                : filtered.OrderByDescending(i => i.Name),
                
            "priority" => SortAscending 
                ? filtered.OrderBy(i => i.Priority) 
                : filtered.OrderByDescending(i => i.Priority),
                
            "price" => SortAscending 
                ? filtered.OrderBy(i => i.Price) 
                : filtered.OrderByDescending(i => i.Price),
                
            _ => filtered
        };

        _filteredItems = filtered.ToList();
    }

    private void SortItems(string sortBy)
    {
        if (SortBy == sortBy)
        {
            // Toggle sort direction
            SortAscending = !SortAscending;
        }
        else
        {
            // New sort field, default to ascending
            SortBy = sortBy;
            SortAscending = true;
        }

        ApplyFiltersAndSort();
    }

    private void ShowAddItemModal()
    {
        _modalItem = new WishlistItemModel();
        _itemModal?.Show(_modalItem);
    }

    private void HandleItemEditClick(WishlistItemModel item)
    {
        _modalItem = new WishlistItemModel
        {
            Id = item.Id,
            Name = item.Name,
            Description = item.Description,
            Price = item.Price,
            Url = item.Url,
            WhereToBuy = item.WhereToBuy,
            Priority = item.Priority,
            IsPrivate = item.IsPrivate,
            Image = item.Image
        };
        _itemModal?.Show(_modalItem);
    }

    private async Task HandleModalSubmit(WishlistItemModel item)
    {
        if (item.Id > 0)
        {
            // Edit existing item
            await WishlistService.UpdateWishlistItemAsync(WishlistId, item.Id, item);
        }
        else
        {
            // Add new item
            await WishlistService.AddItemToWishlistAsync(WishlistId, item);
        }
        await LoadItems();
    }

    private void HandleModalCancel()
    {
        _modalItem = new WishlistItemModel();
    }

    private async Task HandleItemDelete(WishlistItemModel item)
    {
        await WishlistService.RemoveItemFromWishlistAsync(WishlistId, item.Id);
        await LoadItems();
    }

    private Task SetupSecurity()
    {
        if (_wishlist == null || string.IsNullOrEmpty(_currentUserId)) 
            return Task.CompletedTask;

        _isOwner = _wishlist.OwnerId == _currentUserId;
        _canEdit = _isOwner || _wishlist.IsCollaborative;
        return Task.CompletedTask;
    }

    private async Task ShareWishlist()
    {
        string wishlistUrl = NavigationManager.Uri;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", wishlistUrl);
            await JSRuntime.InvokeVoidAsync("alert", "Wishlist URL copied to clipboard!");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", "Unable to copy. Please copy the URL manually.");
        }
    }

    private void SetViewMode(string mode)
    {
        ViewMode = mode;
        StateHasChanged();
    }
}

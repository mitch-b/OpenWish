@page "/events/{EventId}/manage"
@attribute [Authorize]

@using OpenWish.Web.Client.Components.Event
@using OpenWish.Shared.Services
@using System.Collections.Generic
@using System.Linq

@inject IEventService EventService
@inject IUserContextService UserContextService
@inject NavigationManager NavigationManager

@rendermode InteractiveAuto

<PageTitle>Manage Event - @(_event?.Name ?? "")</PageTitle>

@if (_event == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!_isOwner)
{
    <div class="alert alert-danger" role="alert">
        You do not have permission to manage this event.
    </div>
}
else
{
    <div class="event-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Manage Event</h1>
                <button class="btn btn-danger" @onclick="HandleDeleteEvent">
                    <i class="bi bi-trash"></i> Delete Event
                </button>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        @* <FormMappingScope Name="edit-event"> *@
                            <EventForm Model="@_event"
                                     OnSubmit="@HandleSubmit"
                                     ShowValidationSummary="true" />
                        @* </FormMappingScope> *@
                    </div>
                </div>

                <div class="mt-4">
                    <EventWishlistManager EventId="@EventId"
                                           Event="@_event"
                                           CurrentUserId="@_currentUserId"
                                           OnWishlistsChanged="HandleWishlistsChanged" />
                </div>

                @if (_event.IsGiftExchange)
                {
                    <div class="mt-4">
                        <GiftExchangeManager Event="@_event"
                                             CurrentUserId="@_currentUserId"
                                             OnNamesDrawn="HandleNamesDrawn" />
                    </div>
                }
            </div>
            <div class="col-md-4">
                <EventInvitations EventId="@EventId" IsOwner="true" CurrentUserId="@_currentUserId" />

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h3>Manage Participants</h3>
                        @{
                            var participants = GetParticipantList().ToList();
                            var hasOwner = _event?.CreatedBy != null;
                        }
                        <div class="list-group mt-3">
                            @if (hasOwner)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>@GetOwnerDisplayName()</strong>
                                        @if (GetOwnerContactDetail() is { } ownerContact)
                                        {
                                            <div class="small text-muted">@ownerContact</div>
                                        }
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            <span class="badge bg-secondary">Owner</span>
                                        </div>
                                    </div>
                                </div>
                            }

                            @foreach (var participant in participants)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="me-3">
                                        <strong>@GetParticipantDisplayName(participant)</strong>
                                        @if (GetParticipantContactDetail(participant) is { } contact)
                                        {
                                            <div class="small text-muted">@contact</div>
                                        }
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            <span class="badge bg-primary">@participant.Role</span>
                                            <span class="badge @GetStatusBadgeClass(participant)">@GetNormalizedStatus(participant)</span>
                                        </div>
                                    </div>
                                    @if (participant.User?.Id is string participantUserId && participantUserId != _currentUserId)
                                    {
                                        <button class="btn btn-outline-danger btn-sm"
                                                @onclick="() => HandleRemoveParticipant(participant)">
                                            Remove
                                        </button>
                                    }
                                </div>
                            }

                            @if (!hasOwner && participants.Count == 0)
                            {
                                <div class="list-group-item text-muted">No participants yet.</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

@code {
    [Parameter] public string EventId { get; set; } = string.Empty;
    private EventModel? _event;
    private string? _currentUserId;
    private bool _isOwner;

    protected override async Task OnInitializedAsync()
    {
        _currentUserId = await UserContextService.GetUserIdAsync();
        await LoadEvent();
    }

    private async Task LoadEvent()
    {
        _event = await EventService.GetEventByPublicIdAsync(EventId);
        _isOwner = _event?.CreatedBy.Id == _currentUserId;

        if (!_isOwner)
        {
            NavigationManager.NavigateTo($"/events/{EventId}");
        }
    }

    private async Task HandleSubmit(EventModel updatedEvent)
    {
        if (_event != null)
        {
            await EventService.UpdateEventByPublicIdAsync(EventId, updatedEvent);
            NavigationManager.NavigateTo($"/events/{EventId}");
        }
    }

    private async Task HandleDeleteEvent()
    {
        if (_event != null)
        {
            await EventService.DeleteEventByPublicIdAsync(EventId);
            NavigationManager.NavigateTo("/events");
        }
    }

    private async Task HandleRemoveParticipant(EventUserModel participant)
    {
        if (participant.User?.Id is null)
        {
            return;
        }

        await EventService.RemoveUserFromEventByPublicIdAsync(EventId, participant.User.Id);
        await LoadEvent();
    }

    private IEnumerable<EventUserModel> GetParticipantList() =>
        _event?.EventUsers?
            .Where(eu => !IsOwner(eu))
            .OrderBy(eu => GetStatusSortOrder(eu))
            .ThenBy(eu => GetParticipantDisplayName(eu), StringComparer.OrdinalIgnoreCase)
        ?? Enumerable.Empty<EventUserModel>();

    private bool IsOwner(EventUserModel eventUser) =>
        !string.IsNullOrWhiteSpace(_event?.CreatedBy?.Id) &&
        string.Equals(eventUser.User?.Id, _event!.CreatedBy!.Id, StringComparison.Ordinal);

    private static int GetStatusSortOrder(EventUserModel eventUser) => GetNormalizedStatus(eventUser) switch
    {
        "Accepted" => 0,
        "Pending" => 1,
        "Rejected" => 2,
        _ => 3
    };

    private static string GetStatusBadgeClass(EventUserModel eventUser) => GetNormalizedStatus(eventUser) switch
    {
        "Accepted" => "bg-success",
        "Pending" => "bg-warning text-dark",
        "Rejected" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetParticipantDisplayName(EventUserModel eventUser)
    {
        if (!string.IsNullOrWhiteSpace(eventUser.User?.UserName))
        {
            return eventUser.User.UserName!;
        }

        if (!string.IsNullOrWhiteSpace(eventUser.InviteeEmail))
        {
            return eventUser.InviteeEmail!;
        }

        return "Pending Invitation";
    }

    private static string? GetParticipantContactDetail(EventUserModel eventUser)
    {
        if (!string.IsNullOrWhiteSpace(eventUser.User?.Email))
        {
            return eventUser.User.Email!;
        }

        return eventUser.InviteeEmail;
    }

    private string GetOwnerDisplayName()
    {
        if (!string.IsNullOrWhiteSpace(_event?.CreatedBy?.UserName))
        {
            return _event!.CreatedBy!.UserName!;
        }

        if (!string.IsNullOrWhiteSpace(_event?.CreatedBy?.Email))
        {
            return _event!.CreatedBy!.Email!;
        }

        return "Event Owner";
    }

    private string? GetOwnerContactDetail() =>
        string.IsNullOrWhiteSpace(_event?.CreatedBy?.Email) ? null : _event!.CreatedBy!.Email!;

    private static string GetNormalizedStatus(EventUserModel eventUser)
    {
        if (!string.IsNullOrWhiteSpace(eventUser.Status))
        {
            return eventUser.Status;
        }

        return eventUser.IsAccepted ? "Accepted" : "Pending";
    }

    private Task HandleWishlistsChanged(IReadOnlyList<WishlistModel> wishlists)
    {
        if (_event != null)
        {
            _event.EventWishlists = wishlists.ToList();
        }

        return Task.CompletedTask;
    }

    private async Task HandleNamesDrawn()
    {
        await LoadEvent();
    }
}
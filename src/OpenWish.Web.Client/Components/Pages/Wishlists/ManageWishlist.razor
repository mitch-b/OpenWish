@attribute [Authorize]
@page "/wishlists/{WishlistId}/manage"
@using OpenWish.Web.Client.Components.Wishlist
@using OpenWish.Shared.Models
@using System.Collections.Generic
@using System.Linq
@using System.Net.Http

@inject IWishlistService WishlistService
@inject IFriendService FriendService
@inject NavigationManager NavigationManager
@inject IUserContextService UserContextService
@inject ILogger<ManageWishlist> Logger
@inject IEventService EventService

@rendermode InteractiveAuto

<PageTitle>Manage Wishlist - @(_wishlist?.Name ?? "")</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Manage Wishlist</h3>
    <div class="btn-group">
        <a href="/wishlists/@WishlistId" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Wishlist
        </a>
        <button class="btn btn-danger" type="button" @onclick="ShowDeleteDialog">
            <i class="bi bi-trash"></i> Delete Wishlist
        </button>
    </div>
</div>

@if (_wishlist == null)
{
    <p>Loading...</p>
}
else if (!_isOwner)
{
    <div class="alert alert-danger">
        You don't have permission to manage this wishlist.
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <WishlistForm Model="_wishlist" OnSubmit="HandleSubmit" />
        </div>
    </div>

    <div class="card mt-4 friends-access-card">
        <div class="card-body">
            <div class="section-header">
                <div class="section-icon">üëÄ</div>
                <div>
                    <h4 class="h5 mb-0">Who Can See This?</h4>
                    <p class="text-muted small mb-0">Manage who has access to your wishlist</p>
                </div>
            </div>

            @if (_loadingFriendsWithAccess)
            {
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Finding your friends...</span>
                </div>
            }
            else if (_friendsWithAccess.Count == 0)
            {
                <div class="empty-state-card">
                    @if (_wishlist.IsPrivate)
                    {
                        <div class="empty-icon">üîê</div>
                        <h5>Secret Mode Activated!</h5>
                        <p>This wishlist is private. Only you can see it ‚Äì your wishes are safe with you!</p>
                    }
                    else if (_wishlist.IsFriendsOnly)
                    {
                        <div class="empty-icon">üéØ</div>
                        <h5>Ready to Share?</h5>
                        <p>Your wishlist is set to "Specific Friends Only" but you haven't added anyone yet. Use the dropdown below to invite friends!</p>
                    }
                    else
                    {
                        <div class="empty-icon">üí´</div>
                        <h5>No Friends Yet</h5>
                        <p>All your friends can see this wishlist, but it looks like you're new here!</p>
                        <a href="/friends" class="btn btn-primary btn-fun">
                            <span>ü§ù</span> Find Friends
                        </a>
                    }
                </div>
            }
            else
            {
                <div class="visibility-status">
                    @if (_wishlist.IsPrivate)
                    {
                        <span class="status-badge status-private">üîê Private</span>
                    }
                    else if (_wishlist.IsFriendsOnly)
                    {
                        <span class="status-badge status-specific">üéØ Specific Friends</span>
                    }
                    else
                    {
                        <span class="status-badge status-all">üë• All Friends</span>
                    }
                    <span class="friend-count">@_friendsWithAccess.Count friend@(_friendsWithAccess.Count != 1 ? "s" : "") can see this</span>
                </div>

                <div class="friends-grid">
                    @foreach (var friend in _friendsWithAccess)
                    {
                        <div class="friend-chip">
                            <div class="friend-avatar">
                                @((friend.UserName ?? friend.Email ?? "?")[0].ToString().ToUpper())
                            </div>
                            <span class="friend-name">@(friend.UserName ?? friend.Email ?? "Unknown")</span>
                            @if (_wishlist.IsFriendsOnly || _wishlist.IsPrivate)
                            {
                                <button class="remove-btn"
                                        @onclick="() => RemoveFriendAccess(friend.Id!)"
                                        disabled="@_sharingBusy"
                                        title="Remove access">
                                    ‚úï
                                </button>
                            }
                        </div>
                    }
                </div>
            }

            @if (_wishlist.IsFriendsOnly && _availableFriendsToShare.Count > 0)
            {
                <div class="add-friend-section">
                    <div class="add-friend-header">
                        <span class="add-icon">‚ûï</span>
                        <span>Add a Friend</span>
                    </div>
                    <div class="add-friend-form">
                        <select class="form-select friend-select" @bind="_selectedFriendToShareId" disabled="@_sharingBusy">
                            <option value="">Choose a friend to invite...</option>
                            @foreach (var friend in _availableFriendsToShare)
                            {
                                <option value="@friend.Id">@(friend.UserName ?? friend.Email ?? "Unknown")</option>
                            }
                        </select>
                        <button class="btn btn-primary btn-add"
                                type="button"
                                disabled="@(string.IsNullOrEmpty(_selectedFriendToShareId) || _sharingBusy)"
                                @onclick="AddFriendAccess">
                            <span>üéÅ</span> Share
                        </button>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(_sharingStatusMessage))
            {
                <div class="alert alert-success success-toast mt-3" role="alert">
                    <span>‚ú®</span> @_sharingStatusMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(_sharingErrorMessage))
            {
                <div class="alert alert-danger error-toast mt-3" role="alert">
                    <span>üòï</span> @_sharingErrorMessage
                </div>
            }
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-body">
            <h4 class="h5">Event Association</h4>

            @if (!string.IsNullOrEmpty(_eventStatusMessage))
            {
                <div class="alert alert-success" role="alert">@_eventStatusMessage</div>
            }

            @if (!string.IsNullOrEmpty(_eventErrorMessage))
            {
                <div class="alert alert-danger" role="alert">@_eventErrorMessage</div>
            }

            @if (_attachedEvent is not null)
            {
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-semibold">@_attachedEvent.Name</div>
                        <div class="small text-muted">@_attachedEvent.Date.ToString("MMMM d, yyyy")</div>
                        @if (_attachedEvent.Budget.HasValue)
                        {
                            <div class="small text-muted">Budget: @_attachedEvent.Budget.Value.ToString("C")</div>
                        }
                    </div>
                    <div class="btn-group">
                        <a href="/events/@_attachedEvent.PublicId" class="btn btn-outline-primary btn-sm">View Event</a>
                        <button class="btn btn-outline-secondary btn-sm"
                                type="button"
                                disabled="@_eventBusy"
                                @onclick="DetachFromEventAsync">
                            Remove
                        </button>
                    </div>
                </div>
            }
            else if (_availableEvents.Any())
            {
                <div class="mb-3">
                    <label class="form-label">Attach to an event</label>
                    <div class="input-group">
                        <select class="form-select"
                                @bind="_selectedEventId"
                                disabled="@_eventBusy">
                            <option value="">Select an event</option>
                            @foreach (var evt in _availableEvents)
                            {
                                <option value="@evt.Id">@GetEventOptionLabel(evt)</option>
                            }
                        </select>
                        <button class="btn btn-primary"
                                type="button"
                                disabled="@(!_selectedEventId.HasValue || _eventBusy)"
                                @onclick="AttachToSelectedEventAsync">
                            Attach
                        </button>
                    </div>
                </div>
            }
            else
            {
                <p class="text-muted small mb-0">You do not have any upcoming events to attach this wishlist to yet.</p>
            }
        </div>
    </div>
}

<WishlistDeleteDialog @ref="deleteDialog" OnConfirm="HandleDeleteWishlist" />

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

@code {
    [Parameter]
    public string WishlistId { get; set; } = string.Empty;

    private WishlistModel? _wishlist;
    private WishlistDeleteDialog deleteDialog = null!;
    private string? _currentUserId;
    private bool _isOwner;
    private List<EventModel> _availableEvents = [];
    private EventModel? _attachedEvent;
    private int? _selectedEventId;
    private bool _eventBusy;
    private string? _eventStatusMessage;
    private string? _eventErrorMessage;

    // Friends with access
    private List<ApplicationUserModel> _friendsWithAccess = [];
    private List<ApplicationUserModel> _allFriends = [];
    private List<ApplicationUserModel> _availableFriendsToShare = [];
    private bool _loadingFriendsWithAccess = true;
    private string _selectedFriendToShareId = "";
    private bool _sharingBusy;
    private string? _sharingStatusMessage;
    private string? _sharingErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentUserId = await UserContextService.GetUserIdAsync();
            _wishlist = await WishlistService.GetWishlistByPublicIdAsync(WishlistId, _currentUserId);
            await SetupSecurity();

            if (_isOwner)
            {
                await Task.WhenAll(RefreshEventsAsync(), RefreshFriendsWithAccessAsync());
            }
        }
        catch (UnauthorizedAccessException)
        {
            // Redirect to access denied or navigate away
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
        catch (KeyNotFoundException)
        {
            // Wishlist not found, redirect to wishlists
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
    }

    private Task SetupSecurity()
    {
        if (_wishlist == null || string.IsNullOrEmpty(_currentUserId))
            return Task.CompletedTask;

        _isOwner = _wishlist.OwnerId == _currentUserId;
        return Task.CompletedTask;
    }

    private async Task RefreshFriendsWithAccessAsync()
    {
        if (string.IsNullOrEmpty(_currentUserId) || _wishlist == null)
        {
            _friendsWithAccess.Clear();
            _loadingFriendsWithAccess = false;
            return;
        }

        try
        {
            _loadingFriendsWithAccess = true;

            // Get friends with access
            _friendsWithAccess = (await WishlistService.GetFriendsWithAccessByPublicIdAsync(WishlistId)).ToList();

            // Get all friends for the add dropdown
            _allFriends = (await FriendService.GetFriendsAsync(_currentUserId)).ToList();

            // Calculate available friends (those not already with access)
            var friendsWithAccessIds = _friendsWithAccess.Select(f => f.Id).ToHashSet();
            _availableFriendsToShare = _allFriends.Where(f => !friendsWithAccessIds.Contains(f.Id)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load friends with access for wishlist {WishlistId}", WishlistId);
            _friendsWithAccess.Clear();
        }
        finally
        {
            _loadingFriendsWithAccess = false;
        }
    }

    private async Task AddFriendAccess()
    {
        if (string.IsNullOrEmpty(_selectedFriendToShareId) || _wishlist == null)
            return;

        try
        {
            _sharingBusy = true;
            _sharingErrorMessage = null;
            _sharingStatusMessage = null;

            await WishlistService.ShareWishlistByPublicIdAsync(WishlistId, _selectedFriendToShareId, "View");

            var friendName = _allFriends.FirstOrDefault(f => f.Id == _selectedFriendToShareId)?.UserName ?? "Friend";
            _sharingStatusMessage = $"Access granted to {friendName}.";
            _selectedFriendToShareId = "";

            await RefreshFriendsWithAccessAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add friend access for wishlist {WishlistId}", WishlistId);
            _sharingErrorMessage = "Failed to grant access. Please try again.";
        }
        finally
        {
            _sharingBusy = false;
            StateHasChanged();
        }
    }

    private async Task RemoveFriendAccess(string friendId)
    {
        if (string.IsNullOrEmpty(friendId) || _wishlist == null)
            return;

        try
        {
            _sharingBusy = true;
            _sharingErrorMessage = null;
            _sharingStatusMessage = null;

            await WishlistService.RemoveWishlistPermissionByPublicIdAsync(WishlistId, friendId);

            var friendName = _friendsWithAccess.FirstOrDefault(f => f.Id == friendId)?.UserName ?? "Friend";
            _sharingStatusMessage = $"Access removed for {friendName}.";

            await RefreshFriendsWithAccessAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to remove friend access for wishlist {WishlistId}", WishlistId);
            _sharingErrorMessage = "Failed to remove access. Please try again.";
        }
        finally
        {
            _sharingBusy = false;
            StateHasChanged();
        }
    }

    private async Task HandleSubmit(WishlistModel updatedWishlist)
    {
        await WishlistService.UpdateWishlistByPublicIdAsync(WishlistId, updatedWishlist);
        // Refresh to show updated visibility
        _wishlist = await WishlistService.GetWishlistByPublicIdAsync(WishlistId, _currentUserId);
        await RefreshFriendsWithAccessAsync();
        StateHasChanged();
    }

    private void ShowDeleteDialog()
    {
        deleteDialog.Show(
            "Delete Wishlist",
            $"Are you sure you want to delete the wishlist '{_wishlist?.Name}'? This action cannot be undone."
        );
    }

    private async Task HandleDeleteWishlist()
    {
        try
        {
            await WishlistService.DeleteWishlistByPublicIdAsync(WishlistId);
            NavigationManager.NavigateTo("/wishlists");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting wishlist {WishlistId}", WishlistId);
        }
    }

    private async Task RefreshEventsAsync()
    {
        if (string.IsNullOrEmpty(_currentUserId))
        {
            _availableEvents.Clear();
            _attachedEvent = null;
            return;
        }

        try
        {
            var events = (await EventService.GetUserEventsAsync(_currentUserId)).ToList();
            _availableEvents = events
                .Where(e => _wishlist?.EventId == null || e.Id != _wishlist.EventId)
                .OrderBy(e => e.Date)
                .ToList();

            if (_wishlist?.EventId is int eventId)
            {
                _attachedEvent = await EventService.GetEventAsync(eventId);
            }
            else
            {
                _attachedEvent = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load events for wishlist {WishlistId}", WishlistId);
            _availableEvents.Clear();

            if (_wishlist?.EventId is int eventId)
            {
                try
                {
                    _attachedEvent = await EventService.GetEventAsync(eventId);
                }
                catch (Exception innerEx)
                {
                    Logger.LogWarning(innerEx, "Failed to fetch event {EventId} for wishlist {WishlistId}", eventId, WishlistId);
                    _attachedEvent = null;
                }
            }
        }
    }

    private async Task AttachToSelectedEventAsync()
    {
        if (!_selectedEventId.HasValue || _wishlist == null || string.IsNullOrEmpty(_currentUserId))
        {
            return;
        }

        var eventId = _selectedEventId.Value;

        await ExecuteEventAction(async () =>
        {
            // Get the event to get its PublicId
            var selectedEvent = await EventService.GetEventAsync(eventId);
            await EventService.AttachWishlistByPublicIdAsync(selectedEvent.PublicId, WishlistId, _currentUserId);
            _wishlist.EventId = eventId;
            _attachedEvent = selectedEvent;
            _eventStatusMessage = $"Attached to '{_attachedEvent.Name}'.";
            _selectedEventId = null;
        });
    }

    private async Task DetachFromEventAsync()
    {
        if (_attachedEvent == null || _wishlist == null || string.IsNullOrEmpty(_currentUserId))
        {
            return;
        }

        var eventPublicId = _attachedEvent.PublicId;
        var eventName = _attachedEvent.Name;

        await ExecuteEventAction(async () =>
        {
            var removed = await EventService.DetachWishlistByPublicIdAsync(eventPublicId, WishlistId, _currentUserId);
            if (removed)
            {
                _wishlist.EventId = null;
                _attachedEvent = null;
                _eventStatusMessage = $"Removed this wishlist from '{eventName}'.";
            }
        });
    }

    private async Task ExecuteEventAction(Func<Task> action)
    {
        try
        {
            _eventBusy = true;
            _eventErrorMessage = null;
            _eventStatusMessage = null;

            await action();
            await RefreshEventsAsync();
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Network error updating events for wishlist {WishlistId}", WishlistId);
            _eventErrorMessage = "We couldn't reach the server. Please try again.";
        }
        catch (UnauthorizedAccessException ex)
        {
            Logger.LogWarning(ex, "Unauthorized attempt to modify event assignment for wishlist {WishlistId}", WishlistId);
            _eventErrorMessage = "You do not have permission to update event associations.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error updating event association for wishlist {WishlistId}", WishlistId);
            _eventErrorMessage = ex.Message;
        }
        finally
        {
            _eventBusy = false;
            StateHasChanged();
        }
    }

    private static string GetEventOptionLabel(EventModel evt)
    {
        return $"{evt.Name} ({evt.Date:MMM d, yyyy})";
    }
}

@attribute [Authorize]
@page "/wishlists/{WishlistId:int}"

@using OpenWish.Shared.Services
@using OpenWish.Web.Client.Components.Wishlist

@inject IUserContextService UserContextService
@inject IWishlistService WishlistService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@rendermode InteractiveAuto

<PageTitle>@(_wishlist?.Name ?? "Wishlist")</PageTitle>

@if (_wishlist == null)
{
    <div class="loading-container">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading wishlist...</p>
    </div>
}
else
{
    <div class="wishlist-hero">
        <div class="hero-content">
            <div class="hero-title">
                @if (!string.IsNullOrEmpty(_wishlist.Icon))
                {
                    <span class="hero-icon">@_wishlist.Icon</span>
                }
                <h1>@_wishlist.Name</h1>
            </div>
            @if (_wishlist.IsCollaborative)
            {
                <span class="badge badge-collaborative">
                    <i class="bi bi-people-fill"></i> Collaborative
                </span>
            }
        </div>
        <div class="hero-actions">
            <button class="btn btn-secondary" @onclick="ShareWishlist">
                <i class="bi bi-share"></i>
                <span class="btn-text">Share</span>
            </button>
            @if (_isOwner)
            {
                <a href="/wishlists/@WishlistId/manage" class="btn btn-secondary">
                    <i class="bi bi-gear"></i>
                    <span class="btn-text">Manage</span>
                </a>
            }
        </div>
    </div>

    <div class="stats-dashboard">
        <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <div class="stat-value">@_items.Count</div>
                <div class="stat-label">Total Items</div>
            </div>
        </div>
        @if (!_isOwner)
        {
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value">@GetReservedCount()</div>
                    <div class="stat-label">Reserved</div>
                </div>
            </div>
        }
        <div class="stat-card">
            <div class="stat-icon">üí¨</div>
            <div class="stat-content">
                <div class="stat-value">@GetCommentCount()</div>
                <div class="stat-label">Comments</div>
            </div>
        </div>
    </div>

    <div class="search-filter-bar">
        <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text"
                   class="search-input"
                   placeholder="Search items by name, description, or store..."
                   @bind="SearchQuery"
                   @bind:event="oninput"
                   @onkeyup="HandleSearchInput" />
            @if (!string.IsNullOrEmpty(SearchQuery))
            {
                <button class="search-clear" @onclick="ClearSearch">
                    <i class="bi bi-x-lg"></i>
                </button>
            }
        </div>

        <button class="btn btn-filter @(_showFilters ? "active" : "")" @onclick="ToggleFilters">
            <i class="bi bi-funnel"></i>
            <span class="btn-text">Filters</span>
            @if (GetActiveFilterCount() > 0)
            {
                <span class="filter-count">@GetActiveFilterCount()</span>
            }
        </button>

        <div class="btn-group view-toggle">
            <button type="button" class="btn @(ViewMode == "grid" ? "active" : "")" @onclick="@(() => SetViewMode("grid"))" title="Grid View">
                <i class="bi bi-grid-3x3-gap"></i>
            </button>
            <button type="button" class="btn @(ViewMode == "list" ? "active" : "")" @onclick="@(() => SetViewMode("list"))" title="List View">
                <i class="bi bi-list-ul"></i>
            </button>
        </div>
    </div>

    @if (_showFilters)
    {
        <div class="filter-panel">
            <div class="filter-section">
                <label class="filter-label">Priority</label>
                <div class="filter-chips">
                    <button class="filter-chip @(PriorityFilters.Contains("1") ? "active" : "")" @onclick='() => ToggleFilter(PriorityFilters, "1")'>
                        <span class="priority-dot high"></span> High
                    </button>
                    <button class="filter-chip @(PriorityFilters.Contains("2") ? "active" : "")" @onclick='() => ToggleFilter(PriorityFilters, "2")'>
                        <span class="priority-dot medium"></span> Medium
                    </button>
                    <button class="filter-chip @(PriorityFilters.Contains("3") ? "active" : "")" @onclick='() => ToggleFilter(PriorityFilters, "3")'>
                        <span class="priority-dot low"></span> Low
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <label class="filter-label">Status</label>
                <div class="filter-chips">
                    @if (!_isOwner)
                    {
                        <button class="filter-chip @(StatusFilters.Contains("reserved") ? "active" : "")" @onclick='() => ToggleFilter(StatusFilters, "reserved")'>
                            <i class="bi bi-check-circle"></i> Reserved
                        </button>
                        <button class="filter-chip @(StatusFilters.Contains("unreserved") ? "active" : "")" @onclick='() => ToggleFilter(StatusFilters, "unreserved")'>
                            <i class="bi bi-circle"></i> Available
                        </button>
                    }
                    <button class="filter-chip @(StatusFilters.Contains("commented") ? "active" : "")" @onclick='() => ToggleFilter(StatusFilters, "commented")'>
                        <i class="bi bi-chat"></i> Has Comments
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <label class="filter-label">Price Range: @GetPriceRangeLabel()</label>
                <div class="price-range-slider">
                    <input type="range"
                           class="form-range"
                           min="0"
                           max="@GetMaxPrice()"
                           step="10"
                           @bind="MinPrice"
                           @bind:event="oninput"
                           @onchange="ApplyFiltersAndSort" />
                    <input type="range"
                           class="form-range"
                           min="0"
                           max="@GetMaxPrice()"
                           step="10"
                           @bind="MaxPrice"
                           @bind:event="oninput"
                           @onchange="ApplyFiltersAndSort" />
                </div>
            </div>

            <div class="filter-section">
                <label class="filter-label">Sort By</label>
                <div class="sort-options">
                    <button class="sort-option @(SortBy == "priority" ? "active" : "")" @onclick="@(() => SortItems("priority"))">
                        <i class="bi bi-star"></i> Priority
                        @if (SortBy == "priority")
                        {
                            <i class="bi @(SortAscending ? "bi-arrow-up" : "bi-arrow-down")"></i>
                        }
                    </button>
                    <button class="sort-option @(SortBy == "price" ? "active" : "")" @onclick="@(() => SortItems("price"))">
                        <i class="bi bi-currency-dollar"></i> Price
                        @if (SortBy == "price")
                        {
                            <i class="bi @(SortAscending ? "bi-arrow-up" : "bi-arrow-down")"></i>
                        }
                    </button>
                    <button class="sort-option @(SortBy == "name" ? "active" : "")" @onclick="@(() => SortItems("name"))">
                        <i class="bi bi-sort-alpha-down"></i> Name
                        @if (SortBy == "name")
                        {
                            <i class="bi @(SortAscending ? "bi-arrow-up" : "bi-arrow-down")"></i>
                        }
                    </button>
                    <button class="sort-option @(SortBy == "date" ? "active" : "")" @onclick="@(() => SortItems("date"))">
                        <i class="bi bi-calendar"></i> Date Added
                        @if (SortBy == "date")
                        {
                            <i class="bi @(SortAscending ? "bi-arrow-up" : "bi-arrow-down")"></i>
                        }
                    </button>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-link" @onclick="ClearAllFilters">Clear All</button>
                <span class="filter-results">Showing @_filteredItems.Count of @_items.Count items</span>
            </div>
        </div>
    }

    <div class="wishlist-content @ViewMode-view">
        @if (_items != null)
        {
            @if (_filteredItems.Count == 0)
            {
                <div class="empty-state">
                    @if (_items.Count == 0)
                    {
                        <div class="empty-icon">üéÅ</div>
                        <h3>Your wishlist is empty</h3>
                        <p>Start adding items you'd love to receive!</p>
                        @if (_canEdit)
                        {
                            <button class="btn btn-primary btn-lg" @onclick="ShowAddItemModal">
                                <i class="bi bi-plus-lg"></i> Add Your First Item
                            </button>
                        }
                    }
                    else
                    {
                        <div class="empty-icon">üîç</div>
                        <h3>No items match your filters</h3>
                        <p>Try adjusting your search or filter criteria</p>
                        <button class="btn btn-outline-primary" @onclick="ClearAllFilters">
                            <i class="bi bi-x-circle"></i> Clear Filters
                        </button>
                    }
                </div>
            }
            else if (ViewMode == "grid")
            {
                <div class="items-grid">
                    @foreach (var item in _filteredItems)
                    {
                        <div class="wishlist-item-card">
                            @if (!string.IsNullOrEmpty(item.Image))
                            {
                                <div class="item-image">
                                    <img src="@item.Image" alt="@item.Name" />
                                    @if (!_isOwner && item.Reservations.Any())
                                    {
                                        <div class="item-badge reserved">
                                            <i class="bi bi-check-circle-fill"></i> Reserved
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="item-image item-image-placeholder">
                                    <i class="bi bi-gift"></i>
                                    @if (!_isOwner && item.Reservations.Any())
                                    {
                                        <div class="item-badge reserved">
                                            <i class="bi bi-check-circle-fill"></i> Reserved
                                        </div>
                                    }
                                </div>
                            }

                            <div class="item-content">
                                <div class="item-header">
                                    <h3 class="item-title">@item.Name</h3>
                                    @if (item.Priority.HasValue)
                                    {
                                        <span class="priority-indicator priority-@item.Priority.Value">
                                            @GetPriorityIcon(item.Priority.Value)
                                        </span>
                                    }
                                </div>

                                @if (!string.IsNullOrEmpty(item.Description))
                                {
                                    <p class="item-description">@item.Description</p>
                                }

                                <div class="item-meta">
                                    @if (item.Price.HasValue)
                                    {
                                        <span class="item-price">@item.Price.Value.ToString("C")</span>
                                    }
                                    @if (!string.IsNullOrEmpty(item.WhereToBuy))
                                    {
                                        <span class="item-store">
                                            <i class="bi bi-shop"></i> @item.WhereToBuy
                                        </span>
                                    }
                                </div>

                                <div class="item-interactions">
                                    @if (item.Comments.Any())
                                    {
                                        <span class="interaction-badge">
                                            <i class="bi bi-chat-fill"></i> @item.Comments.Count
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(item.Url))
                                    {
                                        <a href="@item.Url" target="_blank" class="interaction-badge" title="View Product">
                                            <i class="bi bi-link-45deg"></i>
                                        </a>
                                    }
                                </div>
                            </div>

                            <div class="item-actions">
                                @if (_canEdit)
                                {
                                    <button class="btn-icon" @onclick="() => HandleItemEditClick(item)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn-icon btn-danger" @onclick="() => HandleItemDelete(item)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                }
                                <button class="btn-icon" @onclick="() => ToggleItemDetails(item.Id)" title="More Details">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                            </div>

                            @if (_expandedItemId == item.Id)
                            {
                                <div class="item-details-expanded">
                                    <div class="details-section">
                                        <h4><i class="bi bi-info-circle"></i> Details</h4>
                                        <div class="details-grid">
                                            <div class="detail-item">
                                                <span class="detail-label">Added</span>
                                                <span class="detail-value">@item.CreatedOn.ToString("MMM dd, yyyy")</span>
                                            </div>
                                            @if (item.Priority.HasValue)
                                            {
                                                <div class="detail-item">
                                                    <span class="detail-label">Priority</span>
                                                    <span class="detail-value">@GetPriorityText(item.Priority.Value)</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    @if (item.Reservations.Any() || item.Comments.Any())
                                    {
                                        <div class="details-section">
                                            <h4><i class="bi bi-people"></i> Social</h4>
                                            @if (!_isOwner && item.Reservations.Any())
                                            {
                                                <p class="detail-info">‚úì This item has been reserved</p>
                                            }
                                            @if (item.Comments.Any())
                                            {
                                                <p class="detail-info">üí¨ @item.Comments.Count comment(s)</p>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                @if (_canEdit)
                {
                    <WishlistItemList Items="@_filteredItems"
                                    OnEdit="@HandleItemEditClick"
                                    OnDelete="@HandleItemDelete"
                                    ShowInteractions="true"
                                    WishlistId="@WishlistId"
                                    OwnerId="@(_wishlist?.OwnerId ?? "")"
                                    IsOwner="@_isOwner" />
                }
                else
                {
                    <WishlistItemList Items="@_filteredItems"
                                    ShowInteractions="true"
                                    WishlistId="@WishlistId"
                                    OwnerId="@(_wishlist?.OwnerId ?? "")"
                                    IsOwner="@_isOwner" />
                }
            }
        }
        else
        {
            <div class="loading-container">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading items...</p>
            </div>
        }
    </div>

    @if (_canEdit)
    {
        <button class="fab" @onclick="ShowAddItemModal" title="Add New Item">
            <i class="bi bi-plus-lg"></i>
        </button>
    }
}

<WishlistItemModal @ref="_itemModal" Model="@_modalItem" OnSubmit="@HandleModalSubmit" OnCancel="@HandleModalCancel" />

<OpenWish.Web.Client.Components.Diagnostics.SessionInformation />

@code {

    [Parameter]
    public int WishlistId { get; set; }

    private WishlistModel? _wishlist;
    private List<WishlistItemModel> _items = new();
    private List<WishlistItemModel> _filteredItems = new();
    private WishlistItemModel _modalItem = new();
    private WishlistItemModal? _itemModal;
    private string? _currentUserId;
    private bool _canEdit;
    private bool _isOwner;
    private string SortBy { get; set; } = "priority";
    private bool SortAscending { get; set; } = true;
    private string ViewMode { get; set; } = "grid"; // "grid" or "list"
    private string SearchQuery { get; set; } = "";
    private bool _showFilters = false;
    private HashSet<string> PriorityFilters = new();
    private HashSet<string> StatusFilters = new();
    private decimal MinPrice { get; set; } = 0;
    private decimal MaxPrice { get; set; } = 10000;
    private int? _expandedItemId = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentUserId = await UserContextService.GetUserIdAsync();
            _wishlist = await WishlistService.GetWishlistAsync(WishlistId, _currentUserId);
            await SetupSecurity();
            await LoadItems();
        }
        catch (UnauthorizedAccessException)
        {
            // Redirect to access denied or navigate away
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
        catch (KeyNotFoundException)
        {
            // Wishlist not found, redirect to wishlists
            NavigationManager.NavigateTo("/wishlists", replace: true);
        }
    }

    private async Task LoadItems()
    {
        _items = (await WishlistService.GetWishlistItemsAsync(WishlistId)).ToList();
        ApplyFiltersAndSort();
    }

    private void ApplyFiltersAndSort()
    {
        var filtered = _items.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            var query = SearchQuery.ToLower();
            filtered = filtered.Where(i =>
                (i.Name?.ToLower().Contains(query) ?? false) ||
                (i.Description?.ToLower().Contains(query) ?? false) ||
                (i.WhereToBuy?.ToLower().Contains(query) ?? false));
        }

        // Apply priority filters
        if (PriorityFilters.Any())
        {
            filtered = filtered.Where(i => i.Priority.HasValue && PriorityFilters.Contains(i.Priority.Value.ToString()));
        }

        // Apply status filters
        if (StatusFilters.Any())
        {
            foreach (var status in StatusFilters)
            {
                filtered = status switch
                {
                    "reserved" => filtered.Where(i => i.Reservations.Any()),
                    "unreserved" => filtered.Where(i => !i.Reservations.Any()),
                    "commented" => filtered.Where(i => i.Comments.Any()),
                    _ => filtered
                };
            }
        }

        // Apply price range filter
        if (MinPrice > 0 || MaxPrice < 10000)
        {
            filtered = filtered.Where(i => i.Price.HasValue && i.Price >= MinPrice && i.Price <= MaxPrice);
        }

        // Apply sorting
        filtered = SortBy switch
        {
            "name" => SortAscending
                ? filtered.OrderBy(i => i.Name)
                : filtered.OrderByDescending(i => i.Name),

            "priority" => SortAscending
                ? filtered.OrderBy(i => i.Priority ?? int.MaxValue)
                : filtered.OrderByDescending(i => i.Priority ?? int.MinValue),

            "price" => SortAscending
                ? filtered.OrderBy(i => i.Price ?? decimal.MaxValue)
                : filtered.OrderByDescending(i => i.Price ?? decimal.MinValue),

            "date" => SortAscending
                ? filtered.OrderBy(i => i.CreatedOn)
                : filtered.OrderByDescending(i => i.CreatedOn),

            _ => filtered
        };

        _filteredItems = filtered.ToList();
    }

    private int GetReservedCount()
    {
        return _items.Count(i => i.Reservations.Any());
    }

    private int GetCommentCount()
    {
        return _items.Sum(i => i.Comments.Count);
    }

    private void ToggleFilters()
    {
        _showFilters = !_showFilters;
    }

    private void ToggleFilter(HashSet<string> filterSet, string value)
    {
        if (filterSet.Contains(value))
        {
            filterSet.Remove(value);
        }
        else
        {
            filterSet.Add(value);
        }
        ApplyFiltersAndSort();
    }

    private void HandleSearchInput()
    {
        ApplyFiltersAndSort();
    }

    private void ClearSearch()
    {
        SearchQuery = "";
        ApplyFiltersAndSort();
    }

    private int GetActiveFilterCount()
    {
        int count = 0;
        count += PriorityFilters.Count;
        count += StatusFilters.Count;
        if (MinPrice > 0 || MaxPrice < 10000) count++;
        if (!string.IsNullOrWhiteSpace(SearchQuery)) count++;
        return count;
    }

    private void ClearAllFilters()
    {
        SearchQuery = "";
        PriorityFilters.Clear();
        StatusFilters.Clear();
        MinPrice = 0;
        MaxPrice = 10000;
        ApplyFiltersAndSort();
    }

    private decimal GetMaxPrice()
    {
        if (!_items.Any()) return 1000;
        var max = _items.Where(i => i.Price.HasValue).Select(i => i.Price!.Value).DefaultIfEmpty(1000).Max();
        return Math.Ceiling(max / 100) * 100; // Round up to nearest 100
    }

    private string GetPriceRangeLabel()
    {
        if (MinPrice == 0 && MaxPrice >= GetMaxPrice())
        {
            return "All Prices";
        }
        return $"{MinPrice:C} - {MaxPrice:C}";
    }

    private void SortItems(string sortBy)
    {
        if (SortBy == sortBy)
        {
            // Toggle sort direction
            SortAscending = !SortAscending;
        }
        else
        {
            // New sort field, default to ascending
            SortBy = sortBy;
            SortAscending = true;
        }

        ApplyFiltersAndSort();
    }

    private void ShowAddItemModal()
    {
        _modalItem = new WishlistItemModel();
        _itemModal?.Show(_modalItem);
    }

    private void HandleItemEditClick(WishlistItemModel item)
    {
        _modalItem = new WishlistItemModel
        {
            Id = item.Id,
            Name = item.Name,
            Description = item.Description,
            Price = item.Price,
            Url = item.Url,
            WhereToBuy = item.WhereToBuy,
            Priority = item.Priority,
            IsPrivate = item.IsPrivate,
            Image = item.Image,
            WishlistId = WishlistId // ensure WishlistId retained to avoid mapping 0
        };
        _itemModal?.Show(_modalItem);
    }

    private async Task HandleModalSubmit(WishlistItemModel item)
    {
        if (item.Id > 0)
        {
            // Edit existing item
            await WishlistService.UpdateWishlistItemAsync(WishlistId, item.Id, item);
        }
        else
        {
            // Add new item
            await WishlistService.AddItemToWishlistAsync(WishlistId, item);
        }
        await LoadItems();
    }

    private void HandleModalCancel()
    {
        _modalItem = new WishlistItemModel();
    }

    private async Task HandleItemDelete(WishlistItemModel item)
    {
        // Prompt for confirmation before deleting
        var name = string.IsNullOrWhiteSpace(item.Name) ? "this item" : $"'{item.Name}'";
        bool confirmed = false;
        try
        {
            confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {name}?");
        }
        catch
        {
            // If confirm fails (e.g., JS not available), default to not deleting.
            confirmed = false;
        }

        if (!confirmed)
            return;

        try
        {
            await WishlistService.RemoveItemFromWishlistAsync(WishlistId, item.Id);
            await LoadItems();
            try
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Item {name} deleted.");
            }
            catch
            {
                // Ignore alert failures
            }
        }
        catch (Exception ex)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to delete {name}. Error: {ex.Message}");
            }
            catch
            {
                // Swallow secondary errors
            }
        }
    }

    private Task SetupSecurity()
    {
        if (_wishlist == null || string.IsNullOrEmpty(_currentUserId))
            return Task.CompletedTask;

        _isOwner = _wishlist.OwnerId == _currentUserId;
        _canEdit = _isOwner || _wishlist.IsCollaborative;
        return Task.CompletedTask;
    }

    private async Task ShareWishlist()
    {
        string wishlistUrl = NavigationManager.Uri;

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", wishlistUrl);
            await JSRuntime.InvokeVoidAsync("alert", "Wishlist URL copied to clipboard!");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", "Unable to copy. Please copy the URL manually.");
        }
    }

    private void SetViewMode(string mode)
    {
        ViewMode = mode;
        StateHasChanged();
    }

    private void ToggleItemDetails(int itemId)
    {
        _expandedItemId = _expandedItemId == itemId ? null : itemId;
    }

    private string GetPriorityIcon(int priority) => priority switch
    {
        1 => "‚≠ê‚≠ê‚≠ê",
        2 => "‚≠ê‚≠ê",
        3 => "‚≠ê",
        _ => ""
    };

    private string GetPriorityText(int priority) => priority switch
    {
        1 => "High Priority",
        2 => "Medium Priority",
        3 => "Low Priority",
        _ => "No Priority"
    };
}

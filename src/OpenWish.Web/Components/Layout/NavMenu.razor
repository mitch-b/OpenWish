@using OpenWish.Web.Services
@using OpenWish.Web.Client.Components.Shared
@using OpenWish.Shared.Services
@implements IDisposable

@inject NavigationManager NavigationManager
@inject IBaseUriService BaseUriService
@inject IAppVersionService AppVersionService
@inject IEventService EventService
@inject IUserContextService UserContextService

<div class="top-row ps-3 navbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="">
      <img src="images/openwish-color.svg" alt="OpenWish" class="openwishsvg" />
      OpenWish</a>
  </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
  <nav class="nav flex-column">
    <div class="nav-item px-3">
      <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
        <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home
      </NavLink>
    </div>

    <AuthorizeView>
      <Authorized>
        <div class="nav-item px-3">
          <NavLink class="nav-link" href="wishlists">
            <span class="bi bi-list-nested-nav-menu" aria-hidden="true"></span> Wishlists
          </NavLink>
        </div>
        <div class="nav-item px-3">
          <NavLink class="nav-link" href="events">
            <span class="bi bi-plus-square-fill-nav-menu" aria-hidden="true"></span> Events
            @if (_pendingInvitationCount > 0)
            {
              <span class="badge bg-warning text-dark ms-1">@_pendingInvitationCount</span>
            }
          </NavLink>
        </div>
        <div class="nav-item px-3">
          <NavLink class="nav-link" href="friends">
            <span class="bi bi-people-fill-nav-menu" aria-hidden="true"></span> Friends
          </NavLink>
        </div>
        <div class="nav-item px-3">
          <NavLink class="nav-link" href="Account/Manage">
            <span class="bi bi-person-fill-nav-menu" aria-hidden="true"></span> @context.User.Identity?.Name
          </NavLink>
        </div>
        <div class="nav-item px-3">
          <form action="Account/Logout" method="post">
            <AntiforgeryToken />
            <input type="hidden" name="ReturnUrl" value="@currentUrl" />
            <button type="submit" class="nav-link">
              <span class="bi bi-arrow-bar-left-nav-menu" aria-hidden="true"></span> Logout
            </button>
          </form>
        </div>
      </Authorized>
      <NotAuthorized>
        <div class="nav-item px-3">
          <NavLink class="nav-link" href="Account/Register">
            <span class="bi bi-person-nav-menu" aria-hidden="true"></span> Register
          </NavLink>
        </div>
        <div class="nav-item px-3">
          <NavLink class="nav-link" href="Account/Login">
            <span class="bi bi-person-badge-nav-menu" aria-hidden="true"></span> Login
          </NavLink>
        </div>
      </NotAuthorized>
    </AuthorizeView>

    <div class="nav-footer px-3 mt-auto">
      <div class="nav-link theme-toggle-host">
        <ThemeToggle />
      </div>
      <p class="nav-link version">
        <span>@AppVersionService.GetAppVersion()</span>
      </p>
    </div>
  </nav>
</div>

@code {
  private string? currentUrl;
  private int _pendingInvitationCount;

  protected override async Task OnInitializedAsync()
  {
    currentUrl = BaseUriService.ToBaseRelativePath(new Uri(NavigationManager.Uri).LocalPath);
    NavigationManager.LocationChanged += OnLocationChanged;
    await LoadPendingInvitationCount();
  }

  private async Task LoadPendingInvitationCount()
  {
    try
    {
      var userId = await UserContextService.GetUserIdAsync();
      if (userId != null)
      {
        var invitations = await EventService.GetPendingInvitationsForUserAsync(userId);
        _pendingInvitationCount = invitations.Count();
      }
    }
    catch
    {
      _pendingInvitationCount = 0;
    }
  }

  private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
  {
    currentUrl = BaseUriService.ToBaseRelativePath(e.Location);
    StateHasChanged();
  }

  public void Dispose()
  {
    NavigationManager.LocationChanged -= OnLocationChanged;
  }
}